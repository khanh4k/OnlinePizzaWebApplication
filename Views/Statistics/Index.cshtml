@{
    ViewData["Title"] = "📊 Thống kê đơn hàng";
    var labels = ViewBag.Labels as string[] ?? new string[0];
    var orderCounts = ViewBag.OrderCounts as int[] ?? new int[0];
    var revenues = ViewBag.Revenues as decimal[] ?? new decimal[0];
    var pizzaNames = ViewBag.PizzaNames as List<string> ?? new List<string>();
}

<div class="container my-5">
    <h2 class="mb-4 fw-bold text-primary">📊 Thống kê đơn hàng</h2>

    <!-- Bộ lọc -->
    <form method="get" class="row g-3 mb-4">
        <div class="col-md-3">
            <label for="startDate">Thời gian bắt đầu:</label>
            <input type="date" name="startDate" id="startDate" class="form-control" value="@(ViewContext.ModelState["startDate"]?.AttemptedValue ?? "")" />
        </div>
        <div class="col-md-3">
            <label for="endDate">Thời gian kết thúc:</label>
            <input type="date" name="endDate" id="endDate" class="form-control" value="@(ViewContext.ModelState["endDate"]?.AttemptedValue ?? "")" />
        </div>
        <div class="col-md-3">
            <label for="type">Loại pizza:</label>
            <select name="type" class="form-control" asp-items="@(new SelectList(pizzaNames))">
                <option value="">Chọn loại pizza đã đặt</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100 mt-4">Lọc</button>
        </div>
    </form>

    <!-- Thống kê nhanh -->
    <div class="row text-center mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm border-primary">
                <div class="card-body">
                    <h5 class="card-title">Tổng số đơn</h5>
                    <h3 class="text-primary fw-bold">@ViewBag.TotalOrders</h3>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm border-success">
                <div class="card-body">
                    <h5 class="card-title">Tổng doanh thu</h5>
                    <h3 class="text-success fw-bold">@ViewBag.TotalRevenue.ToString("N0") ₫</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Biểu đồ -->
    <canvas id="statsChart" height="120"></canvas>

    <!-- Bảng chi tiết -->
    <table class="table table-bordered table-striped mt-4">
        <thead class="table-dark">
            <tr>
                <th>Ngày</th>
                <th>Số đơn</th>
                <th>Doanh thu</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < labels.Length; i++)
            {
                <tr>
                    <td>@labels[i]</td>
                    <td>@orderCounts[i]</td>
                    <td>@revenues[i].ToString("N0") ₫</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Thêm thư viện chartjs-plugin-datalabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
    var ctx = document.getElementById('statsChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(labels)),
            datasets: [
                {
                    label: 'Số đơn',
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(orderCounts)),
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.3)',
                    yAxisID: 'y1',
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#000',
                        formatter: function(value) {
                            return value; // Hiển thị giá trị số đơn
                        }
                    }
                },
                {
                    label: 'Doanh thu',
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(revenues)),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.3)',
                    yAxisID: 'y2',
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#000',
                        formatter: function(value) {
                            return value.toLocaleString() + ' ₫'; // Hiển thị doanh thu với định dạng tiền
                        }
                    }
                }
            ]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            stacked: false,
            plugins: {
                datalabels: {
                    display: true
                }
            },
            scales: {
                y1: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    title: { display: true, text: 'Số đơn' }
                },
                y2: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    title: { display: true, text: 'Doanh thu (₫)' },
                    ticks: {
                        callback: value => value.toLocaleString() + ' ₫'
                    }
                }
            }
        },
        plugins: [ChartDataLabels] // Đăng ký plugin
    });
    // Định nghĩa ChartDataLabels để tránh lỗi
    var ChartDataLabels = window['chartjs-plugin-datalabels'];
</script>